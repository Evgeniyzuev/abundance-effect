# План реализации: Иерархия пользователей (Leaders & Teams)

## 1. Цель
Создать структурированную систему отношений между пользователями, где каждый имеет своего «Лида» (выше) и свою «Команду» (ниже), с автоматическим управлением уровнями и финансовой мотивацией.

## 2. Основные правила

### 2.1. Иерархия
*   **Лид (Lead)**: Пользователь, по чьей реф. ссылке зарегистрировался текущий пользователь.
*   **Команда (Team)**: Все пользователи, зарегистрированные по ссылке текущего пользователя.
*   **Abundance AI**: Глобальный Лид для пользователей верхнего уровня (тех, у кого нет реферера). Представляется в БД как `referrer_id = NULL`.

### 2.2. Правило уровней
*   Лид всегда должен быть выше уровнем, чем участник его команды.
*   **Авто-смена Лида**: Если пользователь догоняет своего Лида по уровню (User Level >= Lead Level), система автоматически назначает ему нового Лида — Лида его текущего Лида. Это продолжается до тех пор, пока не будет найден Лид с более высоким уровнем или пока пользователь не достигнет уровня Abundance AI.

### 2.3. Мотивация
*   **Бонус Лида**: Лид получает **+1% к своему Ядру (Core)** от роста Ядра своей команды.
*   Начисление происходит ежедневно во время работы основного cron-джаба по процентам.

### 2.4. Коммуникация
*   Лид может транслировать сообщения своей команде через систему уведомлений («Колокольчик»).
*   Автоматическая подписка: каждый участник команды по умолчанию «подписан» на обновления своего Лида.

## 3. Техническая реализация

### 3.1. База данных (PostgreSQL / Supabase)
*   **Таблица `users`**: Использование существующих полей `referrer_id` и `level`.
*   **Функция `reassign_lead_if_needed(user_id)`**: Логика поиска нового Лида при повышении уровня.
*   **Триггер**: На запуск функции при обновлении поля `level`.
*   **Cron Job**: Модификация `daily_interest_cron_job` для расчета и начисления 1% бонуса.

### 3.2. Backend (Next.js Server Actions)
*   `broadcastToTeam(message)`: Рассылка уведомлений всем пользователям с определенным `referrer_id`.

### 3.3. Frontend (UI)
*   **Страница «Иерархия»** (на базе текущей страницы рефералов):
    *   Секция «Мой Лид» (вверху): Имя, Аватар, Уровень Лида.
    *   Секция «Моя Команда» (внизу): Список рефералов с их уровнями.
    *   Кнопка «Трансляция»: Для Лидов (доступна, если есть команда).

## 4. Этапы внедрения
1.  **Бэкенд-логика**: Создание SQL функций и триггеров для управления уровнями.
2.  **Экономика**: Обновление cron-скрипта для начисления бонусов.
3.  **Коммуникации**: Реализация Server Action для рассылки сообщений.
4.  **Интерфейс**: Обновление страницы `/referral` до полноценного вида «Иерархия».
