# Инвойсы и Автоматизация Платежей (Invoices & Fulfillment)

Документ описывает систему выставления счетов, процесс оплаты и автоматическую выдачу товаров/результатов после успешной транзакции.

## 1. Архитектура Данных

### Таблица `public.invoices`
Хранит информацию о выставленных счетах.
- `id`: uuid (primary key)
- `seller_id`: uuid (ссылка на `users.id`)
- `amount`: numeric (сумма в Liquid $)
- `title`: text (название товара/услуги)
- `description`: text (опционально)
- `status`: text ('pending', 'paid', 'cancelled', 'expired')
- `type`: text ('one_time', 'multi_use')
- `payload`: jsonb (данные для автоматизации: `item_id`, `achievement_id`, `callback_url` и т.д.)
- `created_at`: timestamp
- `expires_at`: timestamp

## 2. Пользовательский Путь (User Flow)

### Ссылка и QR-код
1. Продавец генерирует ссылку: `https://abundance.effect/pay/[invoice_id]`.
2. Покупатель переходит по ссылке.

### Сценарий А: Авторизованный Пользователь
1. Видит детали счета (название, сумма).
2. Выбор способа оплаты:
   - **Внутренний баланс**: Оплата в один клик через Liquid $.
   - **Внешний (TON)**: Генерация реквизитов для оплаты через кошелек.
3. После оплаты — редирект на "Success Page" + автоматическое начисление товара.

### Сценарий Б: Гость (Неавторизованный)
1. Видит детали счета.
2. Кнопки:
   - **Войти и оплатить**: Редирект на Auth (Google/TG) -> Возврат на страницу оплаты.
   - **Быстрая оплата (без входа)**: Оплата через TON на `NEXT_PUBLIC_DESTINATION_ADDRESS`.
     - *Примечание*: Чтобы выдать товар гостю, система должна либо создать временный аккаунт, либо привязать платеж к Telegram ID/Email, указанному при оплате.

## 3. Логика Исполнения (Fulfillment)

Когда счет переходит в статус `paid`, срабатывает триггер или Edge Function:

1. **Начисление средств**: `seller_id` получает `amount` на свой `wallet_balance`.
2. **Выдача товара**:
   - Если в `payload` указан `item_id`: вызывается функция `grant_item_to_user(user_id, item_id)`.
   - Если указан `achievement_id`: разблокируется достижение.
3. **Уведомление**: Отправка уведомления продавцу и покупателю.

## 4. Оплата без входа (Direct Crypto Payment)

Для оплаты без авторизации используется стандартный механизм `pending_deposits`:
1. Система показывает QR с адресом кошелька и **обязательным комментарием**: `INV-[invoice_id]`.
2. Внешний скрипт (cron/webhook) сканирует блокчейн TON.
3. При нахождении транзакции с нужным комментарием:
   - Invoice помечается как `paid`.
   - Если плательщик не авторизован (но указал e-mail/TG при оплате), система фиксирует право на получение товара за этим идентификатором.

## 5. Смарт-контрактная механика (Internal)

Внутренние платежи работают как атомарная транзакция в БД:
```sql
BEGIN;
  -- Списание у покупателя
  -- Зачисление продавцу
  -- Обновление статуса счета
  -- Добавление айтема в inventory покупателя
COMMIT;
```
Это гарантирует, что покупатель не останется без товара, а продавец без денег.

## 6. Требуемые изменения

### Database
- [ ] Таблица `invoices`.
- [ ] SQL функция `process_invoice_payment(invoice_id, buyer_id)`.
- [ ] SQL функция `grant_item_to_user(user_id, item_id)`.

### Server Actions
- [ ] `createInvoice(data)`: Создание счета.
- [ ] `payInvoiceInternal(invoice_id)`: Оплата с баланса.

### UI
- [ ] Страница `/pay/[id]` (адаптивная, под мобильные).
- [ ] Компонент генерации QR-кода для инвойса.
- [ ] Виджет оплаты в Telegram Mini App.
